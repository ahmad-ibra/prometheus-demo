# Minimal Prometheus for spoke clusters - agent mode, scrape local targets, push to hub
server:
  # Override default global config to prevent duplication
  global:
    scrape_interval: 15s
    scrape_timeout: 10s
    evaluation_interval: 15s
    external_labels:
      cluster: CLUSTER_NAME

  # Remote write configuration
  remoteWrite:
    - url: http://host.docker.internal:9090/api/v1/write

  # NodePort service (mainly for debugging /targets page)
  service:
    type: NodePort
    nodePort: 30090

  # Use emptyDir for agent mode (only needs small buffer for WAL)
  persistentVolume:
    enabled: false

  # Minimal storage for buffering metrics before remote write
  emptyDir:
    sizeLimit: "256Mi"

  resources:
    requests:
      cpu: 200m
      memory: 256Mi
    limits:
      cpu: 500m
      memory: 512Mi

  # Override default flags to enable agent mode with correct storage path
  # This completely replaces default args, preventing --storage.tsdb.path
  defaultFlagsOverride:
    - --config.file=/etc/config/prometheus.yml
    - --storage.agent.path=/data
    - --web.console.libraries=/etc/prometheus/console_libraries
    - --web.console.templates=/etc/prometheus/consoles
    - --web.enable-lifecycle
    - --agent

# Override the entire prometheus.yml to have minimal config
serverFiles:
  prometheus.yml:
    # Empty rule_files (required for agent mode)
    rule_files: []

    # Only scrape node-exporter
    scrape_configs:
      - job_name: 'node-exporter'
        kubernetes_sd_configs:
          - role: endpoints
        relabel_configs:
          # Only scrape node-exporter endpoints
          - source_labels: [__meta_kubernetes_service_name]
            action: keep
            regex: prometheus-prometheus-node-exporter
          - source_labels: [__meta_kubernetes_endpoint_port_name]
            action: keep
            regex: metrics
          # Add node name as label
          - source_labels: [__meta_kubernetes_pod_node_name]
            target_label: node

  # Empty out default rule files
  alerting_rules.yml: {}
  recording_rules.yml: {}
  alerts: {}
  rules: {}

# Enable node-exporter in the same Helm release
prometheus-node-exporter:
  enabled: true
  resources:
    requests:
      cpu: 100m
      memory: 128Mi
    limits:
      cpu: 200m
      memory: 256Mi

# Disable components we don't need on spokes
alertmanager:
  enabled: false

prometheus-pushgateway:
  enabled: false

kube-state-metrics:
  enabled: false
